<!-- pages/index/index.wxml -->
<custom-nav>
  <view slot="title" class="nav-title-wrapper">
    <text>AIåŠ©æ‰‹</text>
    <text class="clear-btn" bindtap="onClearChat" wx:if="{{messages.length > 1}}">æ¸…ç©º</text>
  </view>
</custom-nav>

<view class="page-container">
  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="chat-container" scroll-y scroll-top="{{scrollTop}}" scroll-into-view="{{scrollIntoView}}">
    <view class="messages-wrapper">
      <view class="message-item" wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}">
        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view class="user-message" wx:if="{{item.role === 'user'}}">
          <view class="message-content">
            <text>{{item.content}}</text>
          </view>
          <view class="message-avatar">
            <text>ğŸ‘¤</text>
          </view>
        </view>

        <!-- AIæ¶ˆæ¯ -->
        <view class="assistant-message" wx:else>
          <view class="message-avatar">
            <text>ğŸ¤–</text>
          </view>
          <view class="message-content">
            <!-- æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
            <view class="typing-indicator" wx:if="{{item.isStreaming && !item.content}}">
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
            </view>

            <!-- æ¶ˆæ¯å†…å®¹ -->
            <text wx:if="{{item.content}}" class="{{item.isError ? 'error-text' : ''}}">{{item.content}}</text>

            <!-- æµå¼è¾“å…¥å…‰æ ‡ -->
            <text class="typing-cursor" wx:if="{{item.isStreaming && item.content}}">|</text>
          </view>

          <!-- æ¶ˆæ¯æ“ä½œæŒ‰é’® -->
          <view class="message-actions" wx:if="{{!item.isStreaming && !item.isError}}">
            <text class="action-btn" bindtap="onRegenerateMessage" data-message-id="{{item.id}}">ğŸ”„</text>
            <text class="action-btn" bindtap="onCopyMessage" data-content="{{item.content}}">ğŸ“‹</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <!-- å–æ¶ˆæŒ‰é’® -->
    <view class="cancel-container" wx:if="{{isLoading}}">
      <button class="cancel-btn" bindtap="cancelCurrentRequest">å–æ¶ˆç”Ÿæˆ</button>
    </view>

    <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’® -->
    <view class="input-wrapper">
      <textarea class="input-textarea" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." value="{{inputText}}" bindinput="onInputChange"
        disabled="{{isLoading}}" auto-height maxlength="2000" show-confirm-bar="{{false}}"></textarea>
      <button class="send-btn {{inputText.trim() && !isLoading ? 'active' : 'disabled'}}" bindtap="onSendMessage"
        disabled="{{!inputText.trim() || isLoading}}">
        <text wx:if="{{!isLoading}}">å‘é€</text>
        <text wx:else>...</text>
      </button>
    </view>
  </view>

  <safe-area-bottom backgroundColor="#faf9f5" />
</view>